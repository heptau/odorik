<!DOCTYPE html5>
<html>
  <head>
    <script>
    // NASTAVENÍ //

    // API uživatelské jméno a heslo :: automatické přihlášení //
    var APIuser = "";
    var APIpass = "";

    // Povolit rychlé kontakty :: true = povolit, false = zakázat //
    // př. var enableSpeedDials = false; // zakáže sekci rychlých kontaktů
    var enableContacts = true;

    // Povolit historii volání :: true = povolit, false = zakázat //
    // př. var enableCallHisory = false; // zakáže sekci historie volání
    var enableCallHisory = true;

    // Povolit statistiky volání :: true = povolit, false = zakázat //
    // př. var enableStatistics = false; // zakáže sekci statistiky volání
    var enableStatistics = true;

    // Musí být povolena alespoň jedna kategorie

    // Zamknutá čísla :: čárkou oddělený seznam zkratek (klapek), které nejde editovat //
    // př. var lockedNumbers = "1,7" // zakáže čísla 1 a 7
    var lockedNumbers = "";

    // Skrytí zamknutých čísel :: true = nezobrazovat vůbec, false = zobrazit, ale zakázat úpravy //
    // př. var hideLockedNumbers = true // nezobrazí vůbec 
    var hideLockedNumbers = true;

    // Povolené linky :: čárkou oddělený seznam linek, které jsou uživateli dostupné //
    // Pokud je pole prázdné, tak jsou všechny linky povolené
    // př. var allowedLines = "300100,300200"; // Povolí jen linku 300100 a 300200
    var allowedLines = "";

    // Povolit přidávání nových čísel :: true = povolit, false = zakázat //
    // př. var enableAdding = false // zakáže přidávání
    var enableAdding = true;

    // Povolit upravování nových čísel :: true = povolit, false = zakázat //
    // př. var enableEditing = true // povolí úpravy
    var enableEditing = true;

    // Povolit mazání nových čísel :: true = povolit, false = zakázat //
    // př. var enableRemoving = false // zakáže mazání
    var enableRemoving = true;

    // Povolit callback :: true = povolit, false = zakázat //
    // př. var enableCallback = false // zakáže callback
    var enableCallback = true;

    // Povolit políčko rychlého callbacku :: true = povolit, false = zakázat //
    // př. var enableQuickCallback = false // zakáže políčko callbacku
    var enableQuickCallback = true;

    // Povolit odhlašovaní uživatele :: true = povolit, false = zakázat //
    // př. var enableLogout = false // zakáže odhlašování
    var enableLogout = true;

    // Povolit import/export :: true = povolit, false = zakázat //
    // př. var enableLogout = false // zakáže import/export
    var enableImportExport = true;

    // Povolit úpravu přímo v tabulce :: true = povolit, false = zakázat //
    // Klepněte dvakrát na políčko textu v tabulce a můžete ho přímo upravit //
    // př. var enableInlineEditing = false // zakáže úpravy přímo v tabulce
    var enableInlineEditing = true;

    // Povolit pokročilé filrování  :: true = povolit, false = zakázat //
    // př. var enableFilters = false; // zakáže filtry
    var enableFilters = true;

    // Povolit animace :: true = povolit, false = zakázat //
    // př. var enableAnimations = false; // zakáže animace
    var enableAnimations = true;

    // Přednastavené číslo pro callback //
    // př. var defaultCallbackNumber = "0085023815827"; // nastaví výchozí číslo pro callback na 0085023815827
    var defaultCallbackNumber = "";

    // Přednastavená linka pro callback //
    // př. var defaultCallbackLine = "623400"; // nastaví výchozí linku pro callback na 623400
    var defaultCallbackLine = "";

    // Počet položek na stránku  //
    // př. var pageLength = 24; // nastaví počet položek na stránku na 24
    var pageLength = 24;

    // Povolit tmavé téma :: true = povolit, false = zakázat //
    // Vhodné pro osoby se zrakovými problémy //
    // př. var darkTheme = true // povolí tmavé téma
    var darkTheme = false;

    // KONEC NASTAVENÍ //
    // Pokud chcete upravit nějaké názvy, můžete v HTML kódu níže.
    </script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Odorik: Webová aplikace</title>
    <link href="data:image/x-icon;base64,R0lGODlhIwAeAKEBAOM7O////////////yH5BAEKAAIALAAAAAAjAB4AAAJMjI+pywoPQZssWknp3Tg7vnkfGIoGCZonWppsK76XGsAcbS1wPO20Pvs1bsKKr1gjIhHKZfL4QzlZU2mVdE1lobjmFuJMBMPiB1lUAAA7" rel="icon" type="image/x-icon" />
    <!-- Import of CSS libraries (Semantic UI) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.1.4/components/button.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.1.4/components/card.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.1.4/components/container.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.1.4/components/dimmer.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.1.4/components/dropdown.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.1.4/components/form.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.1.4/components/grid.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.1.4/components/header.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.1.4/components/icon.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.1.4/components/input.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.1.4/components/label.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.1.4/components/loader.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.1.4/components/message.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.1.4/components/menu.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.1.4/components/modal.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.1.4/components/popup.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.1.4/components/reset.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.1.4/components/segment.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.1.4/components/site.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.1.4/components/statistic.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.1.4/components/table.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.1.4/components/transition.min.css">
    <link rel="stylesheet" type="text/css" media="all" href="https://cdn.rawgit.com/BreadMaker/semantic-ui-daterangepicker/master/daterangepicker.min.css" />
    <link href='https://fonts.googleapis.com/css?family=Lato&subset=latin,latin-ext' rel='stylesheet' type='text/css'>
    <style>
        /* Some small improvements */
        .daterangepicker td, .daterangepicker th {
            font-size: 10pt;
        }
        .popup {
            -webkit-filter: none !important;
            filter: none !important;
        }
        @media only screen and (max-width: 767px) {
          .ui.menu .fitted.item {
              padding: 0.8em 1.2em;
          }
        }
    </style>
  </head>
  <body>
    <!-- IE WARNING -->
    <!--[if IE]>
    <div id="warningIE" style="padding-top: 10%; background: white; width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 10; padding: 15px; text-align: center">
        <p>Používáte zastaralý prohlížeč. Nainstalujte si Google Chrome nebo Mozillu Firefox.<br>Pokud používáte jeden z těchto prohlížečů, zkuste znovu načíst stránku klávesou F5.</p>
    </div>
    <!--<![endif]-->

    <!-- CONTAINER -->
    <div class="ui container" style="display: none;">
        <!-- TITLE -->
        <h1 class="ui header">
            <br>Odorik.cz<div class="ui grey label">v1.7</div>
            <span style="float: right; color: #333" class="sub header" id="credit"></span>
        </h1>
        <!-- MENU -->
        <div class="ui secondary stackable menu">
            <!-- CATEGORY SELECTOR DROPDOWN -->
            <div class="item fitted">
                <div class="ui blue floating button dropdown" id="categorySelector">
                    <div class="text"></div><i class="dropdown icon"></i>
                    <div class="menu">
                        <script>
                            if(enableContacts){
                                document.write('<div class="item" data-value="speedDials"><i class="user icon"></i> Rychlé kontakty</div>');
                            }
                            if(enableCallHisory){
                                document.write('<div class="item" data-value="callHistory"><i class="history icon"></i> Výpis volání</div>');
                            }
                            if(enableStatistics){
                                document.write('<div class="item" data-value="statistics"><i class="bar chart icon"></i> Statistiky volání</div>');
                            }
                        </script>
                    </div>
                </div>
            </div>
            <!-- REST OF THE ITEMS (DYNAMICALLY LOADED) -->
            <script>
            if (enableAdding) {
                document.write('<div class="item fitted speedDialsContent"><button class="ui green button" onclick="addContact();"><i class="plus icon"></i> Přidat</button></div>');
            }

            if(enableFilters) {
                document.write('<div class="item fitted callHistoryContent"><button class="ui green button" onclick="filterModal();"><i class="filter icon"></i> Filtrovat</button></div>');
            }

            document.write('<div class="item fitted statisticsContent callHistoryContent"><div id="reportrange" class="ui button"><i class="calendar icon"></i><span></span> <i class="dropdown icon" style="margin:0"></i></div></div>')

            document.write('<div class="item fitted statisticsContent"><div class="ui floating button dropdown" id="statistics-line"><i class="phone icon"></i><div class="text">Všechny</div><i class="dropdown icon"></i><div class="menu"><div class="item" data-value="all">Všechny</div></div></div></div>')

            if (enableImportExport) {
                document.write('<div class="item fitted speedDialsContent"><button class="ui button" onclick="importExportModal();"><i class="file archive outline icon"></i> Import/Export</button></div>');
            }
            if (enableLogout) {
                document.write('<div class="item fitted"><button class="ui button" onclick="logoutModal();"><i class="sign out icon"></i> Odhlásit</button></div>');
            }
            if (enableQuickCallback) {
                document.write('<div class="right item fitted"><div class="ui action input"><input type="text" name="quick-input" placeholder="Volané číslo"><button id="quick-button" class="ui icon button"><i class="call icon"></i></button></div></div>');
            }
            </script>
        </div>
        <!-- SPEED DIALS CONTENT -->
        <div class="speedDialsContent">
            <!-- TABLE -->
            <table class="ui celled compact table">
                <thead>
                    <tr>
                        <th>Zkratka</th>
                        <th>Název</th>
                        <th>Číslo</th>
                        <th class="one wide"></th>
                    </tr>
                </thead>
                <tbody id="tableContacts">
                </tbody>
            </table>
        </div>
        <!-- CALL HISTORY CONTENT -->
        <div class="callHistoryContent">
            <!-- TABLE -->
            <table class="ui celled table">
                <thead>
                    <tr>
                        <th>Druh</th>
                        <th>Datum</th>
                        <th>Odkud</th>
                        <th>Kam</th>
                        <th>Délka</th>
                        <th>Cena</th>
                        <th>Linka</th>
                    </tr>
                </thead>
                <tbody id="tableCalls">
                </tbody>
                <tfoot>
                    <tr><th colspan="7">
                      <div class="ui right floated pagination menu">
                        <a class="icon disabled item" id="prevPage" onclick="if(!$(this).hasClass('disabled')){page-=1;reloadCalls();}">
                          <i class="left chevron icon"></i>
                        </a>
                        <a class="item" id="pageNumber"></a>
                        <a class="icon disabled item" id="nextPage" onclick="if(!$(this).hasClass('disabled')){page+=1;reloadCalls();}">
                          <i class="right chevron icon"></i>
                        </a>
                      </div>
                    </th>
                  </tr>
                </tfoot>
            </table>
        </div>
        <!-- STATISTICS CONTENT -->
        <div class="statisticsContent">
          <div class="ui three column stackable grid">
              <div class="row">
              <div class="column">
                <div class="ui fluid card">
                  <div class="content">
                    <div class="header"><i class="right arrow icon"></i> Příchozí hovory</div>
                  </div>
                  <div class="content">
                  <div class="ui horizontal statistics">
                    <div class="statistic">
                      <div class="value" id="incomingCount">
                        0
                      </div>
                      <div class="label">
                        Hovorů
                      </div>
                    </div>
                    <div class="statistic">
                      <div class="value" id="incomingLength">
                        0
                      </div>
                      <div class="label">
                        Minut
                      </div>
                    </div>
                    <div class="statistic">
                      <div class="value" id="incomingPrice">
                        0
                      </div>
                      <div class="label">
                        Kč
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              </div>
              <div class="column">
                <div class="ui fluid card">
                  <div class="content">
                    <div class="header"><i class="left arrow icon"></i> Odchozí hovory</div>
                  </div>
                  <div class="content">
                  <div class="ui horizontal statistics">
                    <div class="statistic">
                      <div class="value" id="outgoingCount">
                        0
                      </div>
                      <div class="label">
                        Hovorů
                      </div>
                    </div>
                    <div class="statistic">
                      <div class="value" id="outgoingLength">
                        0
                      </div>
                      <div class="label">
                        Minut
                      </div>
                    </div>
                    <div class="statistic">
                      <div class="value" id="outgoingPrice">
                        0
                      </div>
                      <div class="label">
                        Kč
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              </div>
              <div class="column">
                <div class="ui fluid card">
                  <div class="content">
                    <div class="header"><i class="forward mail arrow icon"></i> Přesměrované hovory</div>
                  </div>
                  <div class="content">
                  <div class="ui horizontal statistics">
                    <div class="statistic">
                      <div class="value" id="redirectedCount">
                        0
                      </div>
                      <div class="label">
                        Hovorů
                      </div>
                    </div>
                    <div class="statistic">
                      <div class="value" id="redirectedLength">
                        0
                      </div>
                      <div class="label">
                        Minut
                      </div>
                    </div>
                    <div class="statistic">
                      <div class="value" id="redirectedPrice">
                        0
                      </div>
                      <div class="label">
                        Kč
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            </div>
          </div>

          <div class="ui stackable grid">
            <div class="row">
              <div class="eleven wide column">
                <h3>Podle destinace</h3>
                <table class="ui black celled table">
                    <thead>
                        <tr>
                            <th>Destinace</th>
                            <th>Počet</th>
                            <th>Délka</th>
                            <th>Cena</th>
                            <th>Za minutu</th>
                            <th>Směr</th>
                        </tr>
                    </thead>
                    <tbody id="destinationStatistics">
                    </tbody>
                </table>
              </div>
              <div class="five wide column">
                <h3>Zmeškané</h3>
                <table class="ui red celled table">
                    <thead>
                        <tr>
                            <th>Číslo</th>
                            <th>Počet</th>
                        </tr>
                    </thead>
                    <tbody id="missedStatistics">
                    </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
    </div>
    <!-- DELETE MODAL -->
    <div class="ui modal" id="deleteModal">
        <i class="close icon"></i>
        <div class="header">
            Smazat kontakt
        </div>
        <div class="content">
            <div class="description">
                <p>Opravdu chcete smazat tento rychlý kontakt?</p>
            </div>
        </div>
        <div class="actions">
            <div class="ui black deny button">
                Ne
            </div>
            <div class="ui positive right labeled icon button">
                Smazat
                <i class="trash icon"></i>
            </div>
        </div>
    </div>
    <!-- EDIT MODAL -->
    <div class="ui modal" id="editModal">
        <i class="close icon"></i>
        <div class="header">
            Upravit kontakt
        </div>
        <div class="content">
            <form class="ui form">
                <div class="field">
                    <label>Zkratka</label>
                    <input type="text" name="edit-shortcut">
                </div>
                <div class="field">
                    <label>Název</label>
                    <input type="text" name="edit-name">
                </div>
                <div class="field">
                    <label>Číslo</label>
                    <input type="text" name="edit-number">
                </div>
            </form>
            <p><b>TIP: </b>Lze editovat i dvojklikem na hlavní stránce.</p>
        </div>
        <div class="actions">
            <div class="ui black deny button">
                Zrušit
            </div>
            <div class="ui positive right labeled icon button">
                Upravit
                <i class="checkmark icon"></i>
            </div>
        </div>
    </div>
    <!-- ADD MODAL -->
    <div class="ui modal" id="addModal">
        <i class="close icon"></i>
        <div class="header">
            Přidat kontakt
        </div>
        <div class="content">
            <form class="ui form">
                <div class="field">
                    <label>Zkratka</label>
                    <input type="text" name="add-shortcut" placeholder="Zkratka">
                </div>
                <div class="field">
                    <label>Název</label>
                    <input type="text" name="add-name" placeholder="Název">
                </div>
                <div class="field">
                    <label>Číslo</label>
                    <input type="text" name="add-number" placeholder="Číslo">
                </div>
            </form>
        </div>
        <div class="actions">
            <div class="ui black deny button">
                Zrušit
            </div>
            <div class="ui positive right labeled icon button">
                Přidat
                <i class="checkmark icon"></i>
            </div>
        </div>
    </div>
    <!-- LOGOUT MODAL -->
    <div class="ui modal" id="logoutModal">
        <i class="close icon"></i>
        <div class="header">
            Odhlášení
        </div>
        <div class="content">
            <div class="description">
                <p>Opravdu se chcete odhlásit? Budete muset znovu zadat API jméno a heslo.</p>
            </div>
        </div>
        <div class="actions">
            <div class="ui black deny button">
                Zrušit
            </div>
            <div class="ui positive right labeled icon button">
                Odhlásit
                <i class="sign out icon"></i>
            </div>
        </div>
    </div>
    <!-- LOGIN MODAL -->
    <div class="ui small modal" id="loginModal">
        <div class="header">
          Odorik.cz - webová aplikace
        </div>
        <div class="content">
            <p>API jméno a heslo pro celý účet najdete po přihlášení v menu  <a href="https://www.odorik.cz/ucet/nastaveni_uctu.html?ucet_podmenu=api_heslo" target="_blank">Nastavení účtu <i class="ui angle right icon"></i>API heslo.</a></p>
            <p>Případně je možné zadat SIP jméno (šestimístné číslo linky) a SIP heslo, pak lze zobrazovat jen hovory na oné lince. </p>
            <form class="ui form">
                <div class="field">
                    <label>API jméno</label>
                    <input type="text" name="login-name">
                </div>
                <div class="field">
                    <label>API heslo</label>
                    <input type="password" name="login-pass">
                </div>
            </form>
            <div class="ui negative message" id="badLogin" style="display: none;">
                <div class="header">Nesprávné uživatelské jméno nebo heslo.</div>
            </div>              
            <a href="https://github.com/phavel/odorik/blob/master/index.html">Zdrojový kód</a> této "single page" aplikace je k dispozici <a href="https://github.com/phavel/odorik/">včetně dokumentace</a>. Můžete si jej sami nechat upravit a integrovat  např. do vlastních webových stránek.
        </div>
        <div class="actions">
            <div class="ui positive right labeled icon button">
                Přihlásit se
                <i class="sign in icon"></i>
            </div>
        </div>
    </div>
    <!-- CALL MODAL -->
    <div class="ui modal" id="callModal">
        <i class="close icon"></i>
        <div class="header">
            Objednat callback
        </div>
        <div class="content">
            <form class="ui form">
                <div class="field">
                    <label>Volané číslo</label>
                    <input type="text" name="call-target" disabled>
                </div>
                <div class="field required">
                    <label>Vaše číslo</label>
                    <div class="ui input">
                        <input type="text" name="call-number" placeholder="Číslo, na kterém chcete přijmout callback: číslo vaší linky (s hvězdičkou), rychlá volba, veřejné tel. číslo">
                        <!--<div class="ui button" onclick=""><i class="user icon"></i>Kontakty</div>-->
                    </div>
                </div>
                <div class="field">
                    <label>Linka, kterou bude callback realizován</label>
                    <select class="ui dropdown" name="call-line">
                        <option value="none">Výchozí</option>
                    </select>
                </div>
            </form>
        </div>
        <div class="actions">
            <div class="ui black deny button">
                Zrušit
            </div>
            <div class="ui positive right labeled icon button submit">
                Volat
                <i class="checkmark icon"></i>
            </div>
        </div>
    </div>
    <!-- IMPORT/EXPORT MODAL -->
    <div class="ui modal" id="importExportModal">
        <i class="close icon"></i>
        <div class="header">
            Import/Export
        </div>
        <div class="content">
            <div class="description">
                <p>Tato aplikace umožňuje import a export kontaktů ve formátu <b>vCard</b>.</p>
                <p>Pokud chcete importovat data z Google kontaktů:</p>
                <ol>
                  <li>Na stránce <a href="https://www.google.com/contacts/u/0/?cplus=0#contacts" target="_blank">google.com/contacts</a> vyberte kontakty.
                  <li>Klikněte na <b>Další</b>, a pak <b>Exportovat...</b>. </li>
                  <li>V následujicím okně vyberte formát exportu <b>vCard</b> a stáhněte a uložte soubor s kontakty kliknutím na tlačítko <b>Exportovat</b>.</li>
                  <li>Níže v tomto okně klikněte na tlačítko <b>Importovat</b> a vyberte připravený soubor s kontakty.</li>
                  <li>Jako čísla zkratek budou navrženy následující volné pozice, případně budou použita čísla uložená v poli <b>poznámka</b> u jednotlivých kontaktů.
                      Před uložením dostanete  možnost si vše prohlédnout a ručně upravit, případně import zrušit.
         </li>
                </ol>
                <input id="fileinput" type="file" name="fileinput" style="display: none;" />
            </div>
        </div>
        <div class="actions">
            <div class="ui black deny button">
                Zrušit
            </div>
            <a class="ui blue right labeled icon button" download="Kontakty.vcf" href="#" id="exportButton">
                Exportovat
                <i class="download icon"></i>
            </a>
            <div class="ui green right labeled icon button" id="importButton">
                Importovat
                <i class="wizard icon"></i>
            </div>
        </div>
    </div>
    <!-- IMPORT WIZARD MODAL -->
    <div class="ui modal" id="importWizardModal">
        <i class="close icon"></i>
        <div class="header">
            Import
        </div>
        <div class="content">
            <p>Čísla zkratek i texty k číslům si můžete libovolně upravit. Pokud chcete kontakt vynechat, nastavte jeho zkratku na nulu.</p>
            <p><b>Pozor:</b> Pokud navržená čísla zkratek změníte, může se stát, že si následným uložením přepíšete existující záznamy pod stejným číslem.
                             Budete na to upozorněni zčervenáním čísla zkratky po opuštění editačního pole.</p>
            <table class="ui celled compact table">
                <thead>
                    <tr>
                        <th class="two wide">Zkratka</th>
                        <th>Název</th>
                        <th>Číslo</th>
                    </tr>
                </thead>
                <tbody id="tableImport">
                </tbody>
            </table>
        </div>
        <div class="actions">
            <div class="ui black deny button">
                Zrušit
            </div>
            <div class="ui positive right labeled icon button">
                Dokončit
                <i class="checkmark icon"></i>
            </div>
        </div>
    </div>
    <!-- FILTER MODAL -->
    <div class="ui modal" id="filterModal">
        <i class="close icon"></i>
        <div class="header">
            Filtrovat
        </div>
        <div class="content">
            <form class="ui form">
                <div class="field">
                    <label>Řazení</label>
                    <select class="ui fluid dropdown" name="call-order">
                        <option value="newest" selected>Od nejnovějšího</option>
                        <option value="oldest">Od nejstaršího</option>
                    </select>
                </div>
                <div class="two fields">
                    <div class="field">
                        <label>Linka</label>
                        <select class="ui fluid dropdown" name="line-filter">
                        <option value="all">Vše</option>
                    </select>
                    </div>
                    <div class="field">
                        <label>Stav</label>
                        <select class="ui fluid dropdown" name="state-filter">
                            <option value="all">Vše</option>
                            <option value="missed">Zmeškané</option>
                            <option value="answered">Spojené</option>
                        </select>
                    </div>
                </div>
                <div class="two fields">
                    <div class="field">
                        <label>Směr</label>
                        <select class="ui fluid dropdown" name="direction-filter">
                            <option value="all">Vše</option>
                            <option value="out">Odchozí</option>
                            <option value="in">Příchozí</option>
                            <option value="redirected">Přesměrované</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>Cena</label>
                        <select class="ui fluid dropdown" name="price-filter">
                            <option value="all">Vše</option>
                            <option value="free">Jen zdarma</option>
                            <option value="paid">Jen placené</option>
                        </select>
                    </div>
                </div>
            </form>
        </div>
        <div class="actions">
            <div class="ui black deny button">
                Zrušit
            </div>
            <div class="ui positive right labeled icon button" id="importButton">
                Hotovo
                <i class="checkmark icon"></i>
            </div>
        </div>
    </div>
    <!-- REDIRECTIONS MODAL -->
    <div class="ui modal" id="redirectionsModal">
        <i class="close icon"></i>
        <div class="header">
            Seznam přesměrování během hovoru
        </div>
        <div class="content">
            <div>
                <!-- TABLE -->
                <table class="ui celled table">
                    <thead>
                        <tr>
                            <th>Datum</th>
                            <th>Odkud</th>
                            <th>Kam</th>
                            <th>Délka</th>
                            <th>Cena</th>
                            <th>Linka</th>
                        </tr>
                    </thead>
                    <tbody id="tableRedirects">
                    </tbody>
                </table>
            </div>
        </div>
        <div class="actions">
            <div class="ui black deny button">
                Zavřít
            </div>
        </div>
    </div>
    <!-- DIMMERS -->
    <div class="ui page dimmer" id="dimmer">
      <div class="content">
        <div class="center">
            <h1 class="ui inverted icon header">
          <i class="checkmark icon"></i>
          <small></small>
         </h1>
        </div>
      </div>
    </div>
    <div class="ui page dimmer" id="loadingDimmer">
        <div class="ui loader"></div>
    </div>
    <!-- SCRIPTS -->
    <script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.1.4/semantic.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.6/moment.min.js"></script>
    <script type="text/javascript" src="https://cdn.rawgit.com/BreadMaker/semantic-ui-daterangepicker/master/daterangepicker.min.js"></script>
    <script>
    // Disable caching of AJAX responses (so the data is properly updated)
    $.ajaxSetup({
        cache: false
    });

    // Incompatible browser warning
    if (window.navigator.userAgent.indexOf("MSIE") == -1) {
        document.write("<style type='text/css'>#warningIE {display:none;}</style>");
        $("#warningIE").hide();
    }

    // Initialize helper variables
    var number;
    var array;
    
    if(darkTheme){
        $("body").css("background", "#333");
        $(".header").css("color", "#fff");
    }

    if (enableAnimations) {
        var setDuration = 300;
    } else {
        var setDuration = 0;
    }

    var allNumbers = [];
    var allNames = [];
    var allShortcuts = [];

    var page = 1;
    var totalPages = 1;
    var totalCalls = 1;
    var fromDate;
    var toDate;
    var callHistory = [];
    var redirectedCalls = [];

    var statsLine = -10;

    var preload = false;

    // Detect if user is logged in 
    function loggedIn() {
        // Is the data in localStorage?
        if (localStorage.getItem('username') !== null && localStorage.getItem('password') !== null || (APIuser != "" && APIpass != "")) {
            if (localStorage.getItem('username') !== null && localStorage.getItem('password') !== null) {
                APIuser = localStorage.getItem('username');
                APIpass = localStorage.getItem('password');
            }

            // Is the data valid?
            $.ajax({
                url: 'https://www.odorik.cz/api/v1/lines',
                type: 'GET',
                data: {
                    user: APIuser,
                    password: APIpass
                },
                success: function(result) {
                    // Check if there are any errors
                    if (result.indexOf("error") == -1) {
                        // No errors
                    } else {
                        // Logout and try again
                        logout();
                    }
                }
            });
            return true;
        } else {
            return false;
        }
    }

    // Show login dialog
    function logInDialog() {
        // Initialitze helper variable
        badlogin = false;
        // Show the dialog
        $('#loginModal').modal({
            closable: false,
            duration: setDuration,
            blurring: true,
            onApprove: function() {
                // Animate button
                $("#loginModal .button").addClass("loading");

                // Get values from fields
                APIuser = $('input[name="login-name"]').val();
                APIpass = $('input[name="login-pass"]').val();

                // Connect to API
                $.ajax({
                    url: 'https://www.odorik.cz/api/v1/lines',
                    type: 'GET',
                    data: {
                        user: APIuser,
                        password: APIpass
                    },
                    success: function(result) {
                        // Stop button animation
                        $("#loginModal .button").removeClass("loading");
                        // Check if there are any errors
                        if (result.indexOf("error") == 0) {
                            // Show error animations
                            $("#loginModal").transition('shake', setDuration + "ms");
                            if (badlogin)
                                $('#badLogin').transition("pulse", setDuration + "ms");
                            else {
                                $('#badLogin').transition("fade", setDuration + "ms");
                                badlogin = true;
                            }
                        } else {
                            // Hide and log in
                            $('#loginModal').modal('hide');
                            init();

                            localStorage.setItem('username', APIuser);
                            localStorage.setItem('password', APIpass);
                        }
                    }
                });

                return false;
            }
        }).modal('show');
    }

    // Show logout confirmation modal
    function logoutModal() {
        $('#logoutModal').modal({
            blurring: true,
            duration: setDuration,
            onApprove: function() {
                logout();
            }
        }).modal('show');
    }

    // Log out the user
    function logout() {
        localStorage.removeItem('username');
        localStorage.removeItem('password');

        location.reload();
    }

    // Initialize date
    function initDate(){
        if(typeof localStorage.lastDate == "undefined"){
            $('#reportrange span').html(moment().subtract(29, 'days').format('DD.MM.YYYY') + ' - ' + moment().format('DD.MM.YYYY'));
        }
        else {
            if(localStorage.lastDate == "today"){
                $('#reportrange span').html(moment().format('DD.MM.YYYY') + ' - ' + moment().format('DD.MM.YYYY'));
            }
            else{
                $('#reportrange span').html(localStorage.lastDate);
            }
        }

        fromDate = moment($('#reportrange span').text().split(" - ")[0], 'DD.MM.YYYY').toISOString();
        toDate = moment($('#reportrange span').text().split(" - ")[1], 'DD.MM.YYYY').add(1, "days").toISOString();
    }
    initDate();

    // Initialize dropdown with section selection
    function initDropdown(){
        var firstRun = true;
        $('.ui.dropdown').dropdown();
        $("#statistics-line").dropdown({
            onChange: function(value, text, $selectedItem) {
              if(value != "all") {
                statsLine = value;
              }
              else {
                statsLine = -10;
              }
              loadStatistics();
            }
        });
        $('#categorySelector').dropdown({
            onChange: function(value, text, $selectedItem) {
                if(!firstRun){
                    localStorage.setItem("prevCategory", value);
                    $('#categorySelector').addClass("loading");
                    if(value == "speedDials"){
                        reloadContacts();
                    }
                    if(value == "callHistory"){
                        loadCalls();
                    }
                    if(value == "statistics"){
                        loadStatistics();
                    }
                }
                else {
                    firstRun = false;
                }
            }
        });
    }
    initDropdown();

    if(typeof localStorage.order == "undefined"){
        $("select[name=call-order]").val("newest");
        localStorage.order = "newest"
    }

    if(localStorage.order == "newest"){
        $("select[name=call-order]").val("newest");
    }
    else {
        $("select[name=call-order]").val("oldest");
    }

    // Is user logged in?
    if (loggedIn()) {
        init(); // Load page
    } else {
        logInDialog(); // Show login dialog
    }

    // Initialization
    function init() {
        $("#loadingDimmer").dimmer("show");
        $.ajax({ 
            url: 'https://www.odorik.cz/api/v1/balance',
            type: 'GET',
            data: {
                user: APIuser,
                password: APIpass
            } 
        }).done(function (data, textStatus, xhr) { 
            $("#credit").html("<b>Kredit: </b>"+ data +" Kč");
        });

        updateLines();
        $("input[name=call-number]").val(defaultCallbackNumber);

        if(typeof localStorage.prevCategory == "undefined"){
            localStorage.setItem("prevCategory", "speedDials");
        }

        // Load contacts/calls

        preload = true;
        reloadContacts();

        if((enableContacts && !enableCallHisory && !enableStatistics) || localStorage.prevCategory == "speedDials") {
            $(".ui.dropdown").dropdown("set selected", "speedDials");
            $(".callHistoryContent").hide();
            $(".statisticsContent").hide();
            $(".speedDialsContent").show();
            reloadContacts();
        }
        else if((enableStatistics && !enableCallHisory) || localStorage.prevCategory == "statistics") {
            $(".ui.dropdown").dropdown("set selected", "statistics");
            $(".callHistoryContent").hide();
            $(".speedDialsContent").hide();
            $(".statisticsContent").show();
            loadStatistics();
        }
        else {
            $(".ui.dropdown").dropdown("set selected", "callHistory");
            $(".speedDialsContent").hide();
            $(".statisticsContent").hide();
            $(".callHistoryContent").show();
            loadCalls();
        }
    }

    // Shows the "dimmer" element - for displaying error messages
    function dim(status, text) {
        if (status == true) {
            $('#dimmer h1 i').removeClass("warning");
            $('#dimmer h1 i').removeClass("sign");
            $('#dimmer h1 i').removeClass("checkmark");
            $('#dimmer h1 i').addClass("checkmark");
        } else {
            $('#dimmer h1 i').removeClass("warning");
            $('#dimmer h1 i').removeClass("sign");
            $('#dimmer h1 i').removeClass("checkmark");
            $('#dimmer h1 i').addClass("warning");
            $('#dimmer h1 i').addClass("sign");
        }
        $('#dimmer small').html(text);
        setTimeout("$('#dimmer').dimmer('show');", 800)
        setTimeout("$('#dimmer').dimmer('hide');", 2100);
    }

    /*
     CONTACTS SECTION
    */

    // Reload list
    function reloadContacts() {
        allShortcuts = [];
        allNumbers = [];
        allNames = [];

        $.ajax({
            url: 'https://www.odorik.cz/api/v1/speed_dials.json',
            type: 'GET',
            data: {
                user: APIuser,
                password: APIpass
            },
            success: function(result) {
                array = result;
                outstring = "";
                for (var i = 0; i < result.length; i++) {
                    allNumbers.push(result[i].number);
                    allShortcuts.push(result[i].shortcut);
                    allNames.push(result[i].name);
                    if (editableLine("main", result[i].shortcut)) {
                        outstring += '<tr><td class="table-short-'+result[i].shortcut+'">' + result[i].shortcut + '</td>' + '<td class="table-name-'+result[i].shortcut+'">' + result[i].name + '</td><td class="table-num-'+result[i].shortcut+'">' + result[i].number + '</td><td>';

                        if (enableEditing || enableRemoving || enableCallback)
                            outstring += '<div class="ui icon buttons">';

                        if (enableRemoving)
                            outstring += '<button class="ui red button" onclick="removeContact(\'main\', \'' + result[i].shortcut + '\')"><i class="delete icon"></i></button>';

                        if (enableEditing)
                            outstring += '<button class="ui blue button" onclick="editContact(\'main\', \'' + result[i].shortcut + '\',\'' + result[i].name + '\',\'' + result[i].number + '\')"><i class="edit icon"></i></button>';

                        if (enableCallback)
                            outstring += '<button class="ui green button" onclick="callBack(\'' + result[i].number + '\',\'' + result[i].shortcut + '\',\'' + result[i].name + '\')"><i class="call icon"></i></button>';

                        if (enableEditing || enableRemoving || enableCallback)
                            outstring += '</div>'

                        outstring += '</td></tr>';
                    } else {
                        if (hideLockedNumbers == false) {
                            outstring += '<tr><td class="table-short-'+result[i].shortcut+'">' + result[i].shortcut + '</td>' + '<td class="table-name-'+result[i].shortcut+'">' + result[i].name + '</td><td class="table-num-'+result[i].shortcut+'">' + result[i].number + '</td><td>';
                            outstring += '<div class="ui icon buttons">' + '<button class="ui red button" disabled><i class="delete icon"></i></button>' + '<button class="ui blue button" disabled><i class="edit icon"></i></button>' + '<button class="ui green button" disabled><i class="call icon"></i></button></div>';
                            outstring += '</td></tr>';
                        }
                    }

                }
                $("#tableContacts").html(outstring);


                if(preload == false){
                  if ($(".ui.container").css("display") == "none") {
                    $("#loadingDimmer").dimmer("hide");
                    $("#loadingDimmer").remove();
                    $(".ui.container").transition("fade", setDuration + "ms");
                  }

                  $('#categorySelector').removeClass("loading");

                  $(".statisticsContent").hide();
                  $(".callHistoryContent").hide();
                  $(".speedDialsContent").show();
                }
                else {
                  preload = false;
                }

                if(enableInlineEditing){
                    $("#tableContacts td").dblclick(function(){
                        $(".edited").each(function(){
                            $(this).text($(this).find("input").attr("data-original"));
                        });
                        $(".edited").removeClass("edited");
                        $(this).addClass("edited");

                        $(this).html("<div class='ui icon fluid input'><input type='text' data-original='"+$(this).text()+"' id='inlineInput' value='"+$(this).text()+"'><i id='inlineSubmit' class='link checkmark icon'></i></div>");

                        var id = $(this).attr("class").replace(" edited", "").split("-")[2];

                        $("#inlineInput").keypress(function(e) {
                            if (e.which == 13) {
                                inlineEdit(id);
                            }
                        });
                        $("#inlineSubmit").click(function(){
                            inlineEdit(id);
                        });
                    });
                }
            }
        });
    }

    // Remove Contact
    function removeContact(line, id) {
        $('#deleteModal').modal({
            duration: setDuration,
            blurring: true,
            onApprove: function() {
                if (line == "main") {
                    requestURL = 'https://www.odorik.cz/api/v1/speed_dials/' + id + '.json';
                } else {
                    requestURL = "https://www.odorik.cz/api/v1/lines/" + line + '/speed_dials/' + id + '.json';
                }
                $.ajax({
                    url: requestURL,
                    type: 'DELETE',
                    data: {
                        user: APIuser,
                        password: APIpass
                    },
                    success: function(result) {
                        if (typeof result.errors != "undefined") {
                            parseErrors(result);
                        }
                        setTimeout("reloadContacts();", 500);
                    }
                });
            }
        }).modal('show');
    }

    // Edit Contact
    function editContact(line, id, name, number) {
        $('input[name="edit-shortcut"]').val(id);
        $('input[name="edit-name"]').val(name);
        $('input[name="edit-number"]').val(number);
        $('#editModal').modal({
            duration: setDuration,
            blurring: true,
            onApprove: function() {
                if (line == "main") {
                    requestURL = 'https://www.odorik.cz/api/v1/speed_dials/' + id + '.json';
                } else {
                    requestURL = "https://www.odorik.cz/api/v1/lines/" + line + '/speed_dials/' + id + '.json';
                }
                $.ajax({
                    url: requestURL,
                    type: 'PUT',
                    data: {
                        user: APIuser,
                        password: APIpass,
                        shortcut: $('input[name="edit-shortcut"]').val(),
                        name: $('input[name="edit-name"]').val(),
                        number: $('input[name="edit-number"]').val()
                    },
                    success: function(result) {
                        if (typeof result.errors != "undefined") {
                            parseErrors(result);
                        }
                        setTimeout("reloadContacts();", 500);
                    }
                });
            }
        }).modal('show');
    }

    // Add Contact
    function addContact() {
        $('#addModal').modal({
            duration: setDuration,
            blurring: true,
            onApprove: function() {
                requestURL = 'https://www.odorik.cz/api/v1/speed_dials.json';
                $.ajax({
                    url: requestURL,
                    type: 'POST',
                    data: {
                        user: APIuser,
                        password: APIpass,
                        shortcut: $('input[name="add-shortcut"]').val(),
                        name: $('input[name="add-name"]').val(),
                        number: $('input[name="add-number"]').val()
                    },
                    success: function(result) {
                        if (typeof result.errors != "undefined") {
                            parseErrors(result);
                        }
                        setTimeout("reloadContacts();", 500);
                    }
                });
            }
        }).modal('show');
    }

    // Parse errors
    function parseErrors(resp) {
        var error = resp.errors[0];
        if (error.indexOf("unauthorized") >= 0) {
            showError("Nejste autorizováni k provedení této operace.");
        }
        if (error.indexOf("invalid_number") >= 0) {
            showError("Neplatné číslo.");
        }
        if (error.indexOf("invalid_shortcut") >= 0) {
            showError("Neplatná zkratka.");
        }
        if (error.indexOf("name_too_long") >= 0) {
            showError("Název je příliš dlouhý.");
        }
        if (error.indexOf("shortcut_already_used") >= 0) {
            showError("Zkratka je už použitá.");
        }
        if (error.indexOf("speed_dials_full") >= 0) {
            showError("Rychlé kontakty jsou už plné.");
        }
    }

    // Display errors
    function showError(message) {
        dim(false, message);
    }

    // Detect uneditable lines
    function editableLine(line, number) {
        return $.inArray(number + "", lockedNumbers.split(",")) == -1;
    }

    function inlineEdit(id){
        $(".edited").each(function(){
            $(this).text($(this).find("input").val());
        });
        console.log($('.table-name-'+id).text());
        $(".edited").removeClass("edited");
        $.ajax({
            url: 'https://www.odorik.cz/api/v1/speed_dials/' + id + '.json',
            type: 'PUT',
            data: {
                user: APIuser,
                password: APIpass,
                shortcut: $('.table-short-' +id).text(),
                name: $('.table-name-'+id).text(),
                number: $('.table-num-'+id).text()
            },
            success: function(result) {
                if (typeof result.errors != "undefined") {
                    parseErrors(result);
                }
                setTimeout("reloadContacts();", 500);
            }
        });
    }

    // Call back
    function callBack(number, shortcut, name) {
        if (typeof shortcut !== "undefined") {
            $('input[name="call-target"]').val(number + " - zk. " + shortcut + " (" + name + ")");
        } else {
            $('input[name="call-target"]').val(number);
        }

        if(defaultCallbackLine != "") {
            $('select[name="call-line"]').dropdown("set selected", defaultCallbackLine);
        }

        $('#callModal').modal({
            duration: setDuration,
            blurring: true,
            onApprove: function() {
				$('#callModal form').submit();
				//Return false as to not close modal dialog
				return false; 
            }
        }).modal('show');
        
        //form validation and submit
		$('#callModal form').form({
		  fields: {
		    callNumber: {
		      identifier: 'call-number',
		      rules: [{
				type   : 'regExp[/^((\\*[0-9]{6})|([0-9]{2,3})|([0-9]{9,16}))$/]'
		      }]
		    }
		  },
		  onSuccess : function() {
			var properties = {
                user: APIuser,
                password: APIpass,
                caller: $('input[name="call-number"]').val(),
                recipient: number,
            };
            if($('select[name="call-line"]').val() != "none") {
              properties.line = $('select[name="call-line"]').val();
            }
            requestURL = 'https://www.odorik.cz/api/v1/callback';

            $.ajax({
                url: requestURL,
                type: 'POST',
                data: properties,
                success: function(result) {
                    if (result.indexOf("error") != 0) {
                        dim(true, "Callback objednán");
                    } else {
                        dim(false, "Došlo k chybě. Zkontrolujte zadané číslo.");
                    }
                }
            });
			
			//Hides modal on validation success
			$('#callModal').modal('hide');
			$('#callModal form').unbind(); // Jinak se pri dalsim pouziti formulare zaroven vykona i predchozi onSuccess s drivejsim callbackem!
			return false;
		  }
		});
    }

    // Quick Callback input box
    $("input[name=quick-input]").keypress(function(e) {
        if (e.which == 13) {
            callBack($("input[name=quick-input]").val());
        }
    });
    $("#quick-button").click(function(event) {
        callBack($("input[name=quick-input]").val());
    });

    var textFile = null,
      makeTextFile = function (text) {
        var data = new Blob([text], {type: 'text/plain'});

        // If we are replacing a previously generated file we need to
        // manually revoke the object URL to avoid memory leaks.
        if (textFile !== null) {
          window.URL.revokeObjectURL(textFile);
        }

        textFile = window.URL.createObjectURL(data);

        // returns a URL you can use as a href
        return textFile;
      };

    // Import/Export modal
    function importExportModal() {
        $.ajax({
            url: 'https://www.odorik.cz/api/v1/speed_dials.json',
            type: 'GET',
            data: {
                user: APIuser,
                password: APIpass
            },
            success: function(result) {
                array = result;
                outstring = "";
                for (var i = 0; i < result.length; i++) {
                    outstring += "BEGIN:VCARD\r\n";
                    outstring += "VERSION:3.0\r\n";
                    outstring += "FN:" + result[i].name + "\r\n";
                    outstring += "TEL;TYPE=CELL:" + result[i].number + "\r\n";
                    outstring += "NOTE:" + result[i].shortcut + "\r\n";
                    outstring += "END:VCARD\r\n";
                }
                $("#exportButton").attr("href", makeTextFile(outstring));
            }
        });

        $('#importExportModal').modal({
            duration: setDuration,
            blurring: true
        }).modal('show');
    }

    // Read file
    $("#importButton").click(function() {
        $("#importButton").addClass("loading");
        $("#fileinput").trigger("click");
        if (window.File && window.FileReader && window.FileList && window.Blob) {
            $("#fileinput").change(function(event) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    var text = reader.result;
                    if(text.indexOf("VCARD") > 0){
                        importVCard(text);
                    }
                    else {
                        alert("Toto není platný soubor vCard");
                    }
                }

                reader.readAsText(event.target.files[0], "utf-8");
            });
        } else {
            dim(false, "Váš prohlížeč nepodporuje tuto funkci. Aktualizujte jej.");
        }
    });

    // Parse vCard
    function parse(input) {
        var Re1 = /^(version|fn|title|org|note):(.+)$/i;
        var Re2 = /^([^:;]+);([^:]+):(.+)$/;
        var ReKey = /item\d{1,2}\./;
        var fields = {};

        input.split(/\r\n|\r|\n/).forEach(function(line) {
            var results, key;

            if (Re1.test(line)) {
                results = line.match(Re1);
                key = results[1].toLowerCase();
                fields[key] = results[2];
            } else if (Re2.test(line)) {
                results = line.match(Re2);
                key = results[1].replace(ReKey, '').toLowerCase();

                var meta = {};
                results[2].split(';')
                    .map(function(p, i) {
                        var match = p.match(/([a-z]+)=(.*)/i);
                        if (match) {
                            return [match[1], match[2]];
                        } else {
                            return ["TYPE" + (i === 0 ? "" : i), p];
                        }
                    })
                    .forEach(function(p) {
                        meta[p[0]] = p[1];
                    });

                if (!fields[key]) fields[key] = [];

                fields[key].push({
                    meta: meta,
                    value: results[3].split(';')
                })
            }
        });

        return fields;
    };

    // Helper function for replacing strings
    function replaceAll(find, replace, str) {
        return str.replace(new RegExp(find, 'g'), replace);
    }

    // Unify phone number formats
    function unifyNumber(input) {
        input = replaceAll(" ", "", input);
        input = replaceAll("-", "", input);
        input = input.replace("+", "00");

        if (input.length != 6) {
            if (input.indexOf("00") != 0 && !isNaN(input.substr(0,2))) {
                input = "00420" + input;
            }
        }

        return input;
    }

    // Separate into individual contacts
    function separate(input) {
        card = [];
        array = input.split("END:VCARD");
        for (i = 0; i < array.length; i++) {
            card[i] = parse(array[i] + "END:VCARD");
        }
        return card;
    }

    // Import Wizard modal
    function importVCard(input) {
        // Clear table
        $("#tableImport").html("");
        // Initialize helper variables
        var usedShortcuts = [];
        var usedNumbers = [];
        var contacts = separate(replaceAll("TEL:", "TEL;TYPE=HOME:", input));
        var totalCount = 0;
        // Loop through individual contacts
        for (i = 0; i < contacts.length; i++) {
            contact = contacts[i];
            // Check if number and name is set
            if (typeof contact.tel != "undefined" && typeof contact.fn != "undefined") {
                // Loop through specific phone numbers
                    for (a = 0; a < contact.tel.length; a++) {
                        if($.inArray(unifyNumber(contact.tel[a].value[0]), usedNumbers) == -1){
                            usedNumbers.push(unifyNumber(contact.tel[a].value[0]));
                            totalCount += 1;
                            var shortcut = "";
                            // Check if the shortcut is defined and if not, define it
                            if (typeof contact.note == "undefined" || isNaN(contact.note)) {
                                shortcut = totalCount;
                                while($.inArray(shortcut, allShortcuts) > -1 || $.inArray(shortcut, usedShortcuts) > -1 || shortcut < 200 && shortcut > 99){
                                    shortcut = shortcut + 1;
                                }
                            } else {
                                shortcut = contact.note;
                            }
                            usedShortcuts.push(shortcut);
                            // Add a description
                            var type = "";
                            if(contact.tel.length > 1){
                                console.log("multiple");
                                console.log(contact.tel[a].meta);
                                if(contact.tel[a].meta.TYPE == "HOME"){
                                    type = " (domů)"
                                }
                                if(contact.tel[a].meta.TYPE == "WORK"){
                                    type = " (práce)"
                                }
                                if(contact.tel[a].meta.TYPE == "CELL"){
                                    type = " (mobil)"
                                }
                                if(contact.tel[a].meta.TYPE == "FAX"){
                                    type = " (fax)"
                                }
                            }
                            // Warn against conflicts in shortcuts
                            var warning = "";
                            if($.inArray(Number(shortcut), allShortcuts) > -1){
                                warning = "error";
                            }
                            // Append to table
                            $("#tableImport").append("<tr class='"+ warning +"'><td><div class='ui transparent left icon fluid "+ warning +" input'><i style='display: none' class='remove icon'></i><input class='shortuctImport' id='import-shortuct" + i + "' type='number' min='1' value='" + shortcut + "'></div></td>" + "<td><div class='ui transparent fluid input'><input id='import-name" + i + "' value='" + contact.fn + type + "'></div></td>" + "<td><div class='ui transparent fluid input'><input id='import-number" + i + "' type='tel' value='" + unifyNumber(contact.tel[a].value[0]) + "'></div></td></tr>");
                            }
                        }
                    // Check for change in shortcuts and hide conflict warnings
                    $(".shortuctImport").change(function(){
                        if($.inArray(Number($(this).val()), allShortcuts) == -1){
                            $(this).parent().removeClass("error");
                            $(this).parent().parent().removeClass("error");
                            $(this).parent().parent().find("i").hide();
                        }
                        else {
                            $(this).parent().addClass("error");
                            $(this).parent().parent().addClass("error");
                            $(this).parent().parent().find("i").show();
                        }
                    });
            }
        }
        $("#importButton").removeClass("loading");
        // Show modal with table

        $("#importWizardModal").modal({
            duration: setDuration,
            onApprove: function() {
                // Loop through entries and save them
                for (i = 0; i < contacts.length; i++) {
                    if (typeof $("#import-shortuct" + i).val() != "undefined") {
                        $.ajax({
                            url: 'https://www.odorik.cz/api/v1/speed_dials.json',
                            type: 'POST',
                            data: {
                                user: APIuser,
                                password: APIpass,
                                shortcut: $("#import-shortuct" + i).val(),
                                name: $("#import-name" + i).val(),
                                number: $("#import-number" + i).val()
                            },
                        });
                    }
                }
                setTimeout("reloadContacts();", 1200);
            }
        }).modal("show");
    }

    $("#addModal input").keypress(function(e){
        if (e.which == 13) {
            $("#addModal .positive").click();
        }
    });

    $("#editModal input").keypress(function(e){
        if (e.which == 13) {
            $("#editModal .positive").click();
        }
    });

    $("#loginModal input").keypress(function(e){
        if (e.which == 13) {
            $("#loginModal .positive").click();
        }
    });

    /*
     CALL HISTORY SECTION
    */

    var cb = function(start, end, label) {
        fromDate = start.toISOString();
        toDate = end.toISOString();
        $('#reportrange span').html(start.format('DD.MM.YYYY') + ' - ' + end.format('DD.MM.YYYY'));
        if(moment().format('DD.MM.YYYY') == start.format('D.MM.YYYY')){
            localStorage.setItem("lastDate", "today");
        }
        else {
            localStorage.setItem("lastDate", start.format('DD.MM.YYYY') + ' - ' + end.format('DD.MM.YYYY'));
        }
        if(localStorage.prevCategory == "statistics") {
          loadStatistics();
        }
        else {
          loadCalls();
        }
    };

    var optionSet = {
            startDate: moment($('#reportrange span').text().split(" - ")[0], 'DD.MM.YYYY'),
            endDate: moment($('#reportrange span').text().split(" - ")[1], 'DD.MM.YYYY'),
            dateLimit: {
                days: 60
            },
            showDropdowns: true,
            showWeekNumbers: true,
            timePicker: false,
            timePickerIncrement: 1,
            timePicker12Hour: true,
            ranges: {
                'Dnes': [moment(), moment()],
                'Včera': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
                'Předevčírem': [moment().subtract(2, 'days'), moment().subtract(2, 'days')],
                'Posledních 7 dní': [moment().subtract(6, 'days'), moment()],
                'Posledních 30 dní': [moment().subtract(29, 'days'), moment()],
                'Tento měsíc': [moment().startOf('month'), moment().endOf('month')],
                'Minulý měsíc': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')],
            },
                opens: 'right',
                buttonClasses: ['ui compact button'],
                applyClass: 'primary small',
                cancelClass: 'small',
                format: 'DD.MM.YYYY',
                separator: ' - ',
            locale: {
                applyLabel: 'Uložit',
                cancelLabel: 'Zrušit',
                fromLabel: 'Od',
                toLabel: 'Do',
                customRangeLabel: 'Vlastní',
                weekLabel: 'T',
                daysOfWeek: ['Ne', 'Po', 'Út', 'St', 'Čt', 'Pá', 'So'],
                monthNames: ['Leden', 'Únor', 'Březen', 'Duben', 'Květen', 'Červen', 'Červenec', 'Srpen', 'Září', 'Říjen', 'Listopad', 'Prosinec'],
                firstDay: 1
            }
    };

    $('#reportrange').daterangepicker(optionSet, cb);

    Array.prototype.diff = function(a) {
        return this.filter(function(i) {return a.indexOf(i) < 0;});
    };

    // Reload Calls
    function reloadCalls(){
        if(page < 1) {
            page = 1;
        }

        var startRange = Number((page-1)*pageLength);
        var endRange = page*pageLength;
        var data = callHistory.slice(startRange, endRange);

        if(data.length == pageLength){
            $("#nextPage").removeClass("disabled");
        }
        else {
            $("#nextPage").addClass("disabled");
        }
        if(page > 1){
            $("#prevPage").removeClass("disabled");
        }
        else {
            $("#prevPage").addClass("disabled");
        }

        populateCallsTable(data);
    }

    function loadCalls(){
        callHistory = [];
        callsAmount(function (data, textStatus, xhr) { 
            totalCalls = xhr.getResponseHeader('Odorik-Pages');
            var dataSet = {
                user: APIuser,
                password: APIpass,
                from: fromDate,
                to: toDate,
                page_size: 5000
            };
            if($("select[name=line-filter]").val() != "all"){
                dataSet.line = $("select[name=line-filter]").val();
            }
            if($("select[name=state-filter]").val() != "all"){
                dataSet.status = $("select[name=state-filter]").val();
            }
            if($("select[name=direction-filter]").val() != "all"){
                dataSet.direction = $("select[name=direction-filter]").val();
            }
            if($("select[name=price-filter]").val() != "all"){
                if($("select[name=price-filter]").val() == "free"){
                    dataSet.min_price = "0";
                    dataSet.max_price = "0";
                }
                else {
                    dataSet.min_price = "0";
                    dataSet.max_price = "1000";
                }
            }

            $.ajax({ 
                url: 'https://www.odorik.cz/api/v1/calls.json',
                type: 'GET',
                data: dataSet
            }).done(function (data, textStatus, xhr) {
                if($("select[name=call-order]").val() == "newest"){
                    try {
                        data = data.reverse();
                    }
                    catch(err) {
                        // data jsou nulová - neobrátíme je
                    }
                }

                var finalData = [];

                for(var i = 0; i < data.length;i++){
                    if($.inArray(data[i].line + "", allowedLines.split(",")) != -1 || allowedLines == ""){
                        if(data[i].direction != "redirected") {
                            finalData.push(data[i]);
                        }
                        else {
                            if($.inArray(data[i].redirection_parent_id, redirectedCalls) == -1) {
                                redirectedCalls.push(data[i].redirection_parent_id);
                            }
                        }
                    }
                }

                data = finalData;

                callHistory = callHistory.concat(data);

                if ($(".ui.container").css("display") == "none") {
                    $("#loadingDimmer").dimmer("hide");
                    $("#loadingDimmer").remove();
                    $(".ui.container").transition("fade", setDuration + "ms");
                }

                $('#categorySelector').removeClass("loading");

                $(".speedDialsContent").hide();
                $(".statisticsContent").hide();
                $(".callHistoryContent").show();

                reloadCalls();
            });
        }); 
    }

    function populateCallsTable(result){
        outstring = "";
        for (var i = 0; i < result.length; i++) {
                outstring += '<tr class="';
                if(result[i].status == "missed"){
                    outstring += "error";
                }
                outstring += '"';
                outstring += ' data-id="'+ result[i]. id +'" ';
                if(result[i].redirection_parent_id != "" && typeof result[i].redirection_parent_id != "undefined"){
                    outstring += ' data-redirection-id="'+ result[i].redirection_parent_id +'"';
                }
                outstring += '><td>';
                
                if($.inArray(result[i].id.toString(), redirectedCalls) != -1){
                    outstring += '<a onclick="redirectionsModal('+"'"+result[i].id+"'"+','+"'"+result[i].date+"'"+');" class="ui teal ribbon label"><i class="forward mail icon"></i></a>';
                }

                outstring += '<span class="hasClickPopup" data-html="<b>ID:</b> '+result[i].id+'">';

                if(result[i].direction == "redirected"){
                    outstring += '<i class="forward mail icon"></i> Přesměrovaný';
                }
                if(result[i].direction == "in"){
                    outstring += '<i class="right arrow icon"></i> Příchozí';
                }
                if(result[i].direction == "out"){
                   outstring += '<i class="left arrow icon"></i> Odchozí';
                }
                if(result[i].status == "missed"){
                    outstring += " nepřijatý";
                }
                
                outstring += '</span> ';
                var price = result[i].price.toString().substr(0, result[i].price.toString().indexOf(".") + 3);
                var callLength = ~~(result[i].length / 60) + " min " + (result[i].length % 60) + " s";
                if(result[i].length < 60)
                    callLength = (result[i].length % 60) + " s";
                outstring += '</td><td>' + moment(result[i].date).utcOffset(1).format("DD.MM.YYYY H:mm:ss") + '</td><td>'
                    + getSpeedDialName(result[i].source_number) +'</td><td><span class="hasPopup" data-html="<b>Podrobnosti:</b> '
                    + result[i].destination_name +'">'
                    + getSpeedDialName(result[i].destination_number)+'</span></td><td><span class="hasPopup" data-html="<b>Délka vyzvánění:</b> '
                    + result[i].ringing_length +' s">'
                    + callLength +'</span></td><td><span class="hasPopup" data-html="<b>Minutová sazba:</b> '
                    + result[i].price_per_minute +' Kč<br><b>Zbylý kredit:</b> '
                    + result[i].balance_after +' Kč">'
                    + price +' Kč</span></td><td>' + result[i].line +'</td></tr>';
        }
        $("#tableCalls").html(outstring);
        $(".hasClickPopup").popup({ on: "click" }); 
        $(".hasPopup").popup(); 
        $("#pageNumber").text(page + " z " + Math.ceil(callHistory.length / pageLength));
    }

    // Get name of the contact
    function getSpeedDialName(number){
        if($.inArray(number, allNumbers) != -1){
            return allNames[$.inArray(number, allNumbers)] + " (" + number + ")";
        }
        else {
            return number;
        }
    }

    // Redirections dialog
    function redirectionsModal(id, time){
        $.ajax({ 
            url: 'https://www.odorik.cz/api/v1/calls.json',
            type: 'GET',
            data: {
                user: APIuser,
                password: APIpass,
                from: moment(time).subtract(2, "hours").toISOString(),
                to: moment(time).add(2, "hours").toISOString(),
                direction: "redirected"
            }
        }).done(function (data, textStatus, xhr) {
            outstring = "";
            var result = data;
            for (var i = 0; i < result.length; i++) {
                if(result[i].redirection_parent_id == id) {
                    outstring += '<tr class="';
                    if(result[i].status == "missed"){
                        outstring += "error";
                    }
                    outstring += '">';
                    outstring += '<td>'+moment(result[i].date).utcOffset(1).format("DD.MM.YYYY H:mm:ss")+'</td><td>'+getSpeedDialName(result[i].source_number)+'</td><td><span class="hasPopup" data-html="<b>Podrobnosti:</b> '+result[i].destination_name+'">'+getSpeedDialName(result[i].destination_number)+'</span></td><td><span class="hasPopup" data-html="<b>Délka vyzvánění:</b> '+result[i].ringing_length+' s">'+result[i].length+' s</span></td><td><span class="hasPopup" data-html="<b>Minutová sazba:</b> '+result[i].price_per_minute+' Kč<br><b>Zbylý kredit:</b> '+result[i].balance_after+' Kč">'+result[i].price+' Kč</span></td><td>'+result[i].line+'</td></tr>';
                }
            }

            $("#tableRedirects").html(outstring);
            $(".hasPopup").popup(); 
            $("#redirectionsModal").modal({
                duration: setDuration,
                blurring: true
            }).modal('show');
        });
    }

    // Filter dialog
    function filterModal(){
        $("#filterModal").modal({
            duration: setDuration,
            blurring: true,
            onApprove: function(){
                localStorage.setItem("order", $("select[name=call-order]").val());
                loadCalls();
            }
        }).modal('show');
    }

    // Update lines
    function updateLines(){
        if(allowedLines != ""){
            $("select[name=line-filter]").parent().addClass("disabled");
        }
        $.ajax({
            url: 'https://www.odorik.cz/api/v1/lines',
            type: 'GET',
            data: {
                user: APIuser,
                password: APIpass,
            },
            success: function(result) {
                var data = result.split(",");
                for(var i = 0; i < data.length; i++){
                    $("select[name=line-filter]").append('<option value="'+data[i]+'">'+data[i]+'</option>');
                    $("select[name=call-line]").append('<option value="'+data[i]+'">'+data[i]+'</option>');
                    // TODO here
                    $("#statistics-line .menu").append('<div class="item" data-value="'+data[i]+'">'+data[i]+'</div>');
                }
            }
        });
    }

    // Get total amount of calls
    function callsAmount(finishedFunction){
        var dataSet = {
                user: APIuser,
                password: APIpass,
                from: fromDate,
                to: toDate,
                page_size: 1,
                page: page
        };
        if($("select[name=line-filter]").val() != "all"){
            dataSet.line = $("select[name=line-filter]").val();
        }
        if($("select[name=state-filter]").val() != "all"){
            dataSet.status = $("select[name=state-filter]").val();
        }
        if($("select[name=direction-filter]").val() != "all"){
            dataSet.direction = $("select[name=direction-filter]").val();
        }
        $.ajax({ 
            url: 'https://www.odorik.cz/api/v1/calls.json',
            type: 'GET',
            data: dataSet
        }).done(finishedFunction);
    }

    /*
      STATISTICS SECTION
    */

    function loadStatistics() {
      var formatPrice = function(input) {
        var price = parseFloat(input.toFixed(3));
        if(price > 10) {
          price = price.toFixed(2);
        }
        if(Math.round(price) == price) {
          price = Math.round(price);
        }
        return price;
      };
      var formatLength = function(input) {
        var length = (input/60).toFixed(1);
        if(length > 5 || Math.round(length) == length) {
          length = Math.round(length);
        }
        return length;
      };
      var dataSet = {
        user: APIuser,
        password: APIpass,
        from: fromDate,
        to: toDate
      };
      if(statsLine != -10) {
        dataSet.line = statsLine;
      }
      $.ajax({ 
        url: 'https://www.odorik.cz/api/v1/call_statistics.json',
        type: 'GET',
        data: dataSet
      }).done(function (data, textStatus, xhr) {
        $("#incomingCount").text(data.incoming.count);
        $("#incomingLength").text(formatLength(data.incoming.length));
        $("#incomingPrice").text(formatPrice(data.incoming.price));

        $("#outgoingCount").text(data.outgoing.count);
        $("#outgoingLength").text(formatLength(data.outgoing.length));
        $("#outgoingPrice").text(formatPrice(data.outgoing.price));

        $("#redirectedCount").text(data.redirected.count);
        $("#redirectedLength").text(formatLength(data.redirected.length));
        $("#redirectedPrice").text(formatPrice(data.redirected.price));
      });

      $.ajax({ 
        url: 'https://www.odorik.cz/api/v1/call_statistics/by_destination.json',
        type: 'GET',
        data: dataSet
      }).done(function (data, textStatus, xhr) {
        console.log(data);
        var outString = "";
        for(var i = 0; i < data.length; i++) {
          var direction = "Odchozí";
          if(data[i].direction == "redirected") {
            direction = "Přesměrované";
          }
          else if(data[i].direction == "in") {
            direction = "Příchozí";
          }
          outString += "<tr><td>" + data[i].destination + "</td><td>" + data[i].count + "</td><td>" + formatLength(data[i].length) + " min</td><td>" + formatPrice(data[i].price) + " Kč</td><td>" + data[i].price_per_minute + " Kč</td><td>" + direction + "</td></tr>";
        }
        $("#destinationStatistics").html(outString);
      });

      $.ajax({ 
        url: 'https://www.odorik.cz/api/v1/call_statistics/missed_calls.json',
        type: 'GET',
        data: dataSet
      }).done(function (data, textStatus, xhr) {
        console.log(data);
        var outString = "";
        for(var i = 0; i < data.length; i++) {
          outString += "<tr><td>" + data[i].destination_number + "</td><td>" + data[i].count + "</td></tr>"
        }
        $("#missedStatistics").html(outString);
      });

      if ($(".ui.container").css("display") == "none") {
        $("#loadingDimmer").dimmer("hide");
        $("#loadingDimmer").remove();
        $(".ui.container").transition("fade", setDuration + "ms");
      }
      $('#categorySelector').removeClass("loading");
      $(".speedDialsContent").hide();
      $(".callHistoryContent").hide();
      $(".statisticsContent").show();
    }
    </script>
    <br>
  </body>
</html>
